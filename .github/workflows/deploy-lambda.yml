name: Deploy Lambda

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'auth.py'
      - 'lambda_handler.py'
      - 'pyproject.toml'
      - 'canvas-react/**'
      - '.github/workflows/deploy-lambda.yml'
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1
  FUNCTION_NAME: canvas-ta-dashboard-lambda
  S3_BUCKET: canvas-ta-dashboard-canvas-data-prod-fauigkaq

jobs:
  deploy-lambda:
    name: Build and Deploy to Lambda
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: canvas-react/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build React frontend
        run: |
          cd canvas-react
          npm ci
          npm run build

      - name: Create Lambda deployment package
        run: |
          mkdir -p lambda-package

          # Copy application code
          cp main.py auth.py lambda_handler.py lambda-package/

          # Install Python dependencies for Lambda
          pip install --platform manylinux2014_x86_64 \
            --target=lambda-package \
            --implementation cp \
            --python-version 3.11 \
            --only-binary=:all: \
            --upgrade \
            fastapi pydantic pydantic-settings python-multipart \
            python-dateutil loguru httpx boto3 PyJWT bcrypt \
            email-validator mangum

          # Create zip
          cd lambda-package
          zip -r ../lambda-package.zip . -q
          cd ..

          echo "Package size: $(du -h lambda-package.zip | cut -f1)"

      - name: Upload to S3 and update Lambda
        run: |
          S3_KEY="lambda-deployments/canvas-ta-dashboard-lambda-${{ github.sha }}.zip"

          # Upload to S3
          aws s3 cp lambda-package.zip "s3://${{ env.S3_BUCKET }}/$S3_KEY"

          # Update Lambda function code
          aws lambda update-function-code \
            --function-name ${{ env.FUNCTION_NAME }} \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --s3-key "$S3_KEY" \
            --region ${{ env.AWS_REGION }}

          # Wait for update to complete
          aws lambda wait function-updated \
            --function-name ${{ env.FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Verify deployment
        run: |
          FUNCTION_URL=$(aws lambda get-function-url-config \
            --function-name ${{ env.FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'FunctionUrl' \
            --output text)

          echo "Testing health endpoint..."
          curl -sf "${FUNCTION_URL}health" || exit 1
          echo "Health check passed"

      - name: Deployment summary
        run: |
          FUNCTION_URL=$(aws lambda get-function-url-config \
            --function-name ${{ env.FUNCTION_NAME }} \
            --query 'FunctionUrl' \
            --output text)

          echo "### Lambda Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Function**: \`${{ env.FUNCTION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: $FUNCTION_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lambda deployed successfully" >> $GITHUB_STEP_SUMMARY
